name: Nightlies
on:
  schedule:
    - cron: "0 6 * * *"
  push:
    branches:
      - main
  pull_request:  # To test changes in this workflow
    paths:
      - '.github/workflows/nightlies.yml'

# Only allow one job to run at a time because we're pushing to git repos;
# the string value doesn't matter, just that it's a fixed string.
concurrency:
  group: "just-one-please-${{ github.ref }}"

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  build-debs:
    strategy:
      fail-fast: false
      matrix:
        debian_version:
          - bookworm
    runs-on: ubuntu-latest
    outputs:
      artifact_id: ${{ steps.upload.outputs.artifact-id }}
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false
      - uses: actions/checkout@v6
        with:
          persist-credentials: false
          repository: "freedomofpress/securedrop-builder"
          path: "securedrop-builder"
          lfs: true
      - name: Build packages
        run: |
          git config --global --add safe.directory '*'
          NIGHTLY=1 WHAT=app DEBIAN_VERSION=${{ matrix.debian_version }} BUILDER=securedrop-builder \
            ./scripts/build-debs.sh
      - uses: actions/upload-artifact@v6
        id: upload
        with:
          name: build-${{ matrix.debian_version }}
          path: build
          if-no-files-found: error

  commit-and-push:
    if: ${{ github.ref == 'refs/heads/main' }} # Skip when testing workflow
    runs-on: ubuntu-latest
    container: debian:bookworm
    needs:
      - build-debs
    steps:
      - name: Install dependencies
        run: |
          apt-get update && apt-get install --yes git git-lfs
      # Repeat this for all supported Debian versions
      - name: Download bookworm artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-bookworm
          path: build-bookworm
      - uses: actions/checkout@v6
        with:
          persist-credentials: false
          repository: "freedomofpress/securedrop-apt-test"
          path: "securedrop-apt-test"
          lfs: true
      - uses: actions/checkout@v6
        with:
          persist-credentials: false
          repository: "freedomofpress/build-logs"
          path: "build-logs"
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.FPF_BRANCH_UPDATER_APP_ID }}
          private-key: ${{ secrets.FPF_BRANCH_UPDATER_APP_PRIVKEY }}
          repositories: |
            build-logs
            securedrop-apt-test
      - name: Commit and push
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          LOGS_REPO: freedomofpress/build-logs
          PKG_REPO: freedomofpress/securedrop-apt-test
        run: |
          git config --global user.email "securedrop@freedom.press"
          git config --global user.name "sdcibot-nightlies[bot]"
          # First publish buildinfo files
          cd build-logs
          mkdir -p "buildinfo/$(date +%Y)"
          cp -v ../build-*/*.buildinfo "buildinfo/$(date +%Y)"
          git add .
          git diff-index --quiet HEAD || git commit -m "Publishing buildinfo files for workstation nightlies"
          git push https://x-access-token:${GH_TOKEN}@github.com/${LOGS_REPO}.git main
          # Now the packages themselves
          cd ../securedrop-apt-test
          cp -v ../build-bookworm/*.deb workstation/bookworm-nightlies/
          git add .
          git diff-index --quiet HEAD || git commit -m "Automated SecureDrop workstation build"
          # Sleep before we push so the token will have propagated across GitHub infra
          sleep 5
          git push https://x-access-token:${GH_TOKEN}@github.com/${PKG_REPO}.git main
